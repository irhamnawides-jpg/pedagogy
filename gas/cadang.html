<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aplikasi Tebaran Nilai</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* CSS TETAP SAMA */
</style>
</head>

<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>ğŸ“Š Aplikasi Tebaran Nilai Siswa</h1>
    <p>Sistem Update dan Penyimpanan Data Nilai ke Google Sheet</p>
  </div>

  <!-- Login Section -->
  <div class="login-section" id="loginSection">
    <div class="login-form">
      <h2>ğŸ” Login ke Sistem</h2>
      <div class="form-group">
        <label for="user">Username:</label>
        <input type="text" id="user" placeholder="Masukkan username" value="chair">
      </div>
      <div class="form-group">
        <label for="pass">Password:</label>
        <input type="password" id="pass" placeholder="Masukkan password" value="Login">
      </div>
      <button class="btn btn-login" onclick="login()">
        <span id="loginIcon">ğŸ”‘</span>
        <span id="loginText">Login</span>
      </button>
      <div id="loginStatus" class="status-message"></div>
    </div>
  </div>

  <!-- Main Application (Hidden by default) -->
  <div id="app" class="hidden">
    <!-- Student Info -->
    <div class="student-info">
      <h2 id="judul">ğŸ“‹ Informasi Siswa</h2>
      <div class="info-row">
        <div class="info-item">
          <strong>ğŸ‘¤ Nama Siswa:</strong>
          <span id="namaSiswa">-</span>
        </div>
        <div class="info-item">
          <strong>ğŸ« Kelas:</strong>
          <span id="kelasSiswa">-</span>
        </div>
        <div class="info-item">
          <strong>ğŸ”¢ Kode:</strong>
          <span id="kodeSiswa">-</span>
        </div>
        <div class="info-item">
          <strong>ğŸ“Œ Baris di Sheet:</strong>
          <span id="posisiBaris">-</span>
          <input type="hidden" id="barisSheet" value="">
        </div>
      </div>
    </div>

    <!-- Update Section -->
    <div class="update-section">
      <h3>ğŸ“ Update Nilai (Deret Hitung)</h3>
      <div class="update-controls">
        <div class="control-group">
          <label for="posBab">ğŸ“– Posisi BAB:</label>
          <input type="number" id="posBab" value="1" min="1" max="5">
        </div>
        <div class="control-group">
          <label for="posNilai">ğŸ¯ Posisi Nilai (1-5):</label>
          <input type="number" id="posNilai" value="1" min="1" max="5">
        </div>
        <div class="control-group">
          <label for="nilaiBaru">â­ Nilai Baru (0-100):</label>
          <input type="number" id="nilaiBaru" value="90" min="0" max="100">
        </div>
      </div>
      <button class="btn btn-update" onclick="updateData()">
        <span id="updateIcon">ğŸ”„</span>
        <span id="updateText">Update Nilai</span>
      </button>
      <button class="btn btn-save" onclick="saveToGoogleSheet()">
        <span id="saveIcon">ğŸ’¾</span>
        <span id="saveText">Simpan ke Google Sheet</span>
      </button>
      <div id="updateStatus" class="status-message"></div>
    </div>

    <!-- Table Section -->
    <div class="table-container">
      <table id="nilaiTable">
        <thead>
          <tr>
            <th>MATERI</th>
            <th>LIT GAMBAR</th>
            <th>LIT TEXT</th>
            <th>DEEP LEAR</th>
            <th>KONSEP</th>
            <th>KOGNITIF</th>
          </tr>
        </thead>
        <tbody>
          <!-- Table rows will be generated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Variable Section -->
    <div class="variable-section">
      <h3>ğŸ“„ Isi Variabel:</h3>
      <pre id="hasil"></pre>
      <div id="saveStatus" class="status-message"></div>
      <!-- HAPUS <p id="h"></p> -->
    </div>
  </div>

  <div class="footer">
    <p>Â© 2024 Aplikasi Tebaran Nilai | Data disimpan ke Google Sheets</p>
  </div>
</div>

<script>
// ================= KONFIG =================
const sheetID = "1lueDGzRkaXb4XV0wnWlARF3OmkGnhIrP1Eg6fnBghf0";
const sheetName = "Sheet1";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxnsNFZDFfA0acAAJNvi2QjWZj5YmyMqeCmtNji2l-fJ_L5ldhOSVDgB7D9kTIoyjHfRA/exec";
const lebarBaris = 6;

let memoryDB = "";
let currentRow = 0; // Simpan baris user
let variabel = "";
let variabel2 = "";
let currentUser = "";

// ================= FUNGSI BANTU =================
function showStatus(elementId, message, type = 'info') {
  const statusEl = document.getElementById(elementId);
  statusEl.textContent = message;
  statusEl.className = 'status-message';
  
  switch(type) {
    case 'success':
      statusEl.classList.add('status-success');
      break;
    case 'error':
      statusEl.classList.add('status-error');
      break;
    case 'loading':
      statusEl.classList.add('status-loading');
      break;
  }
}

function setLoading(buttonId, isLoading, loadingText = 'Memproses...') {
  const btn = document.getElementById(buttonId);
  if (isLoading) {
    btn.disabled = true;
    btn.innerHTML = `<span class="loading-spinner"></span> ${loadingText}`;
  } else {
    btn.disabled = false;
    if (buttonId === 'loginText') {
      btn.innerHTML = 'ğŸ”‘ Login';
    } else if (buttonId === 'updateText') {
      btn.innerHTML = 'ğŸ”„ Update Nilai';
    } else if (buttonId === 'saveText') {
      btn.innerHTML = 'ğŸ’¾ Simpan ke Google Sheet';
    }
  }
}

// ================= LOGIN =================
function login() {
  const user = document.getElementById("user").value.trim();
  const pass = document.getElementById("pass").value.trim();

  if (!user || !pass) {
    showStatus('loginStatus', 'âŒ Username dan password harus diisi', 'error');
    return;
  }

  setLoading('loginText', true, 'Memproses login...');
  showStatus('loginStatus', 'ğŸ” Mencari data pengguna...', 'loading');

  // FIXED: Query yang benar
  const safeUser = user.replace(/'/g, "\\'");
  const safePass = pass.replace(/'/g, "\\'");

  const query = `SELECT A WHERE A LIKE '${safeUser}()${safePass}()%'`;

  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${encodeURIComponent(query)}`;
  
  fetch(url)
    .then(res => res.text())
    .then(text => {
      try {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        
        if (!json.table.rows || json.table.rows.length === 0) {
          showStatus('loginStatus', 'âŒ Login gagal. User tidak ditemukan.', 'error');
          setLoading('loginText', false);
          return;
        }

        // Simpan data user
        memoryDB = json.table.rows[0].c[0].v;
        
        // Simpan nomor baris (row + 1 karena indexing dari 0)
        currentRow = json.table.rows[0].c[0].row + 1;
        
        currentUser = user;
        
        // Pisahkan variabel
        const parts = memoryDB.split('#');
        variabel2 = parts[0];
        variabel = parts[1] || "";
        
        console.log('Data ditemukan di baris:', currentRow);
        console.log('Data:', memoryDB);

        // Tampilkan aplikasi utama
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        
        // Update tampilan baris
        document.getElementById("posisiBaris").textContent = currentRow;
        document.getElementById("barisSheet").value = currentRow;
        
        // Render data
        renderTable();
        showStatus('loginStatus', '', 'info');
        setLoading('loginText', false);
        
        // Tampilkan notifikasi sukses
        setTimeout(() => {
          showStatus('updateStatus', `âœ… Login berhasil! Data ditemukan di baris ${currentRow}`, 'success');
          setTimeout(() => {
            showStatus('updateStatus', '', 'info');
          }, 3000);
        }, 500);
        
      } catch (error) {
        console.error('Parse error:', error);
        showStatus('loginStatus', 'âŒ Error parsing data.', 'error');
        setLoading('loginText', false);
      }
    })
    .catch(error => {
      console.error('Login error:', error);
      showStatus('loginStatus', 'âŒ Koneksi ke Google Sheet gagal.', 'error');
      setLoading('loginText', false);
    });
}

// ================= RENDER TABLE =================
function renderTable() {
  if (!variabel) return;

  // Update info siswa
  const meta = variabel2.split("()");
  document.getElementById("namaSiswa").textContent = meta[2] || "-";
  document.getElementById("kelasSiswa").textContent = meta[3] || "-";
  document.getElementById("kodeSiswa").textContent = meta[4] || "-";

  // Render tabel
  const tbody = document.querySelector("#nilaiTable tbody");
  tbody.innerHTML = "";

  const data = variabel.split("|");
  
  // Untuk 5 BAB
  for (let bab = 1; bab <= 5; bab++) {
    const tr = document.createElement("tr");
    const startIndex = (bab - 1) * 6; // 6 kolom per BAB
    
    tr.innerHTML = `
      <td class="materi-cell">BAB ${bab}</td>
      <td>${data[startIndex + 0] || 0}</td>
      <td>${data[startIndex + 1] || 0}</td>
      <td>${data[startIndex + 2] || 0}</td>
      <td>${data[startIndex + 3] || 0}</td>
      <td>${data[startIndex + 4] || 0}</td>
    `;
    tbody.appendChild(tr);
  }

  // Update variabel tampilan
  document.getElementById("hasil").textContent = variabel2 + "#" + variabel;
}

// ================= UPDATE DATA =================
function updateData() {
  const posisiBAB = parseInt(document.getElementById("posBab").value);
  const posisiNilai = parseInt(document.getElementById("posNilai").value);
  const nilaiBaru = document.getElementById("nilaiBaru").value;

  // Validasi input
  if (posisiBAB < 1 || posisiBAB > 5) {
    showStatus('updateStatus', 'âŒ Posisi BAB harus antara 1-5', 'error');
    return;
  }

  if (posisiNilai < 1 || posisiNilai > 5) {
    showStatus('updateStatus', 'âŒ Posisi nilai harus antara 1-5', 'error');
    return;
  }

  if (nilaiBaru === "" || isNaN(nilaiBaru)) {
    showStatus('updateStatus', 'âŒ Nilai baru harus berupa angka', 'error');
    return;
  }

  const nilai = parseInt(nilaiBaru);
  if (nilai < 0 || nilai > 100) {
    showStatus('updateStatus', 'âŒ Nilai harus antara 0-100', 'error');
    return;
  }

  setLoading('updateText', true, 'Mengupdate...');
  showStatus('updateStatus', 'ğŸ”„ Memperbarui nilai...', 'loading');

  // Update data di memory
  let data = variabel.split("|");
  
  // Index = (BAB-1)*6 + posisiNilai
  const index = ((posisiBAB - 1) * 6) + posisiNilai;
  
  // Pastikan array cukup panjang
  while (data.length <= index) {
    data.push("0");
  }

  data[index] = nilai.toString();
  variabel = data.join("|");
  
  // Update memoryDB
  memoryDB = variabel2 + "#" + variabel;

  // Render ulang tabel
  setTimeout(() => {
    renderTable();
    setLoading('updateText', false);
    showStatus('updateStatus', `âœ… Nilai BAB ${posisiBAB}, posisi ${posisiNilai} diupdate menjadi ${nilai}`, 'success');
    
    // Reset status setelah 3 detik
    setTimeout(() => {
      showStatus('updateStatus', '', 'info');
    }, 3000);
  }, 500);
}

// ================= SIMPAN KE GOOGLE SHEET =================
async function saveToGoogleSheet() {
  if (!currentUser || !memoryDB || currentRow === 0) {
    showStatus('saveStatus', 'âŒ Harap login terlebih dahulu', 'error');
    return;
  }

  setLoading('saveText', true, 'Menyimpan...');
  showStatus('saveStatus', `ğŸ“¤ Menyimpan data ke baris ${currentRow}...`, 'loading');

  try {
    // FIXED: Gunakan elemen yang benar
    const dataToSend = memoryDB; // Data dari memory
    const barisToSend = currentRow; // Baris dari login
    
    const url = `${GAS_URL}?baris=${barisToSend}&data=${encodeURIComponent(dataToSend)}`;
    
    const response = await fetch(url, { method: 'POST' });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.text();
    
    setLoading('saveText', false);
    showStatus('saveStatus', `âœ… ${result}`, 'success');
    
    // Reset status setelah 5 detik
    setTimeout(() => {
      showStatus('saveStatus', '', 'info');
    }, 5000);
    
  } catch (error) {
    console.error('Save error:', error);
    setLoading('saveText', false);
    showStatus('saveStatus', `âŒ Gagal: ${error.message}`, 'error');
  }
}

// ================= INISIALISASI =================
window.onload = function() {
  // Set nilai default untuk testing
  document.getElementById("user").value = "chair";
  document.getElementById("pass").value = "Login";
  
  // Focus ke input user
  document.getElementById("user").focus();
  
  // Enter key support
  document.getElementById("pass").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      login();
    }
  });
  
  console.log("Aplikasi Tebaran Nilai siap digunakan");
};
</script>

</body>
</html>
