<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aplikasi Tebaran Nilai</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
  color: #333;
}

.container {
  max-width: 1200px;
  margin: 20px auto;
  background: white;
  border-radius: 15px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  overflow: hidden;
}

.header {
  background: linear-gradient(90deg, #2196F3, #1976D2);
  color: white;
  padding: 25px;
  text-align: center;
}

.header h1 {
  font-size: 28px;
  margin-bottom: 10px;
  font-weight: 600;
}

.login-section {
  padding: 30px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
}

.login-form {
  max-width: 400px;
  margin: 0 auto;
  background: white;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #495057;
}

.form-group input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: border 0.3s;
}

.form-group input:focus {
  outline: none;
  border-color: #2196F3;
}

.btn {
  padding: 14px 25px;
  background: linear-gradient(90deg, #4CAF50, #45a049);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.btn:hover {
  background: linear-gradient(90deg, #45a049, #3d8b40);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
}

.btn-login {
  background: linear-gradient(90deg, #2196F3, #1976D2);
}

.btn-login:hover {
  background: linear-gradient(90deg, #1976D2, #1565C0);
}

.btn-update {
  background: linear-gradient(90deg, #FF9800, #F57C00);
  margin-top: 10px;
}

.btn-update:hover {
  background: linear-gradient(90deg, #F57C00, #EF6C00);
}

.btn-save {
  background: linear-gradient(90deg, #9C27B0, #7B1FA2);
  margin-left: 10px;
}

.btn-save:hover {
  background: linear-gradient(90deg, #7B1FA2, #6A1B9A);
}

.main-content {
  padding: 30px;
}

.hidden {
  display: none !important;
}

.student-info {
  background: linear-gradient(90deg, #E3F2FD, #BBDEFB);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  border-left: 5px solid #2196F3;
}

.student-info h2 {
  color: #1565C0;
  margin-bottom: 15px;
  font-size: 22px;
}

.info-row {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
}

.info-item {
  flex: 1;
  min-width: 250px;
}

.info-item strong {
  color: #0D47A1;
  display: inline-block;
  margin-right: 5px;
}

.update-section {
  background: #FFF3E0;
  padding: 25px;
  border-radius: 10px;
  margin-bottom: 30px;
  border: 2px dashed #FF9800;
}

.update-section h3 {
  color: #E65100;
  margin-bottom: 20px;
  font-size: 20px;
}

.update-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.control-group {
  display: flex;
  flex-direction: column;
}

.control-group label {
  margin-bottom: 8px;
  font-weight: 600;
  color: #5D4037;
}

.control-group input {
  padding: 12px;
  border: 2px solid #FFB74D;
  border-radius: 6px;
  font-size: 16px;
  background: white;
}

.control-group input:focus {
  outline: none;
  border-color: #FF9800;
}

.table-container {
  overflow-x: auto;
  margin-bottom: 30px;
  border-radius: 10px;
  border: 1px solid #dee2e6;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

thead {
  background: linear-gradient(90deg, #424242, #616161);
  color: white;
}

th {
  padding: 18px 15px;
  text-align: center;
  font-weight: 600;
  font-size: 15px;
  border: 1px solid #757575;
}

tbody tr:nth-child(even) {
  background: #f5f5f5;
}

tbody tr:hover {
  background: #E3F2FD;
}

td {
  padding: 15px;
  text-align: center;
  border: 1px solid #e0e0e0;
  font-size: 15px;
}

.materi-cell {
  font-weight: 600;
  color: #1565C0;
  background: #E3F2FD;
}

.variable-section {
  background: #F3E5F5;
  padding: 25px;
  border-radius: 10px;
  margin-top: 30px;
  border: 1px solid #CE93D8;
}

.variable-section h3 {
  color: #7B1FA2;
  margin-bottom: 15px;
  font-size: 20px;
}

#hasil {
  background: white;
  padding: 20px;
  border-radius: 8px;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 14px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-all;
  border: 1px solid #E1BEE7;
  margin-bottom: 20px;
  max-height: 200px;
  overflow-y: auto;
}

.status-message {
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
  font-weight: 600;
  text-align: center;
  display: none;
}

.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  display: block;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  display: block;
}

.status-loading {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
  display: block;
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.footer {
  text-align: center;
  padding: 20px;
  color: #666;
  font-size: 14px;
  border-top: 1px solid #eee;
  background: #f8f9fa;
}

@media (max-width: 768px) {
  .container {
    margin: 10px;
    border-radius: 10px;
  }
  
  .header, .main-content, .login-section {
    padding: 20px;
  }
  
  .info-row {
    flex-direction: column;
    gap: 15px;
  }
  
  .update-controls {
    grid-template-columns: 1fr;
  }
  
  th, td {
    padding: 12px 8px;
    font-size: 14px;
  }
}
</style>
</head>

<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>üìä Aplikasi Tebaran Nilai Siswa</h1>
    <p>Sistem Update dan Penyimpanan Data Nilai ke Google Sheet</p>
  </div>

  <!-- Login Section -->
  <div class="login-section" id="loginSection">
    <div class="login-form">
      <h2>üîê Login ke Sistem</h2>
      <div class="form-group">
        <label for="user">Username:</label>
        <input type="text" id="user" placeholder="Masukkan username" value="chair">
      </div>
      <div class="form-group">
        <label for="pass">Password:</label>
        <input type="password" id="pass" placeholder="Masukkan password" value="Login">
      </div>
      <button class="btn btn-login" onclick="login()">
        <span id="loginIcon">üîë</span>
        <span id="loginText">Login</span>
      </button>
      <div id="loginStatus" class="status-message"></div>
    </div>
  </div>

  <!-- Main Application (Hidden by default) -->
  <div id="app" class="hidden">
    <!-- Student Info -->
    <div class="student-info">
      <h2 id="judul">üìã Informasi Siswa</h2>
      <div class="info-row">
        <div class="info-item">
          <strong>üë§ Nama Siswa:</strong>
          <span id="namaSiswa">-</span>
        </div>
        <div class="info-item">
          <strong>üè´ Kelas:</strong>
          <span id="kelasSiswa">-</span>
        </div>
        <div class="info-item">
          <strong>üî¢ Kode:</strong>
          <span id="kodeSiswa">-</span>
        </div>
      </div>
    </div>

    <!-- Update Section -->
    <div class="update-section">
      <h3>üìù Update Nilai (Deret Hitung)</h3>
      <div class="update-controls">
        <div class="control-group">
          <label for="posBab">üìñ Posisi BAB:</label>
          <input type="number" id="posBab" value="1" min="1" max="5">
        </div>
        <div class="control-group">
          <label for="posNilai">üéØ Posisi Nilai (1-5):</label>
          <input type="number" id="posNilai" value="1" min="1" max="5">
        </div>
        <div class="control-group">
          <label for="nilaiBaru">‚≠ê Nilai Baru (0-100):</label>
          <input type="number" id="nilaiBaru" value="90" min="0" max="100">
        </div>
      </div>
      <button class="btn btn-update" onclick="updateData()">
        <span id="updateIcon">üîÑ</span>
        <span id="updateText">Update Nilai</span>
      </button>
      <button class="btn btn-save" onclick="saveToGoogleSheet()">
        <span id="saveIcon">üíæ</span>
        <span id="saveText">Simpan ke Google Sheet</span>
      </button>
      <div id="updateStatus" class="status-message"></div>
    </div>

    <!-- Table Section -->
    <div class="table-container">
      <table id="nilaiTable">
        <thead>
          <tr>
            <th>MATERI</th>
            <th>LIT GAMBAR</th>
            <th>LIT TEXT</th>
            <th>DEEP LEAR</th>
            <th>KONSEP</th>
            <th>KOGNITIF</th>
          </tr>
        </thead>
        <tbody>
          <!-- Table rows will be generated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Variable Section -->
    <div class="variable-section">
      <h3>üìÑ Isi Variabel:</h3>
      <pre id="hasil"></pre>
      <div id="saveStatus" class="status-message"></div>
    </div>
  </div>

  <div class="footer">
    <p>¬© 2024 Aplikasi Tebaran Nilai | Data disimpan ke Google Sheets</p>
  </div>
</div>

<script>
// ================= KONFIG =================
const sheetID = "1lueDGzRkaXb4XV0wnWlARF3OmkGnhIrP1Eg6fnBghf0";
const sheetName = "Sheet1";
const GAS_URL = "https://script.google.com/macros/s/AKfycbwKHfEZ6TbLZZhpuAXQSiOnEMRPLY36D7TAb_wuK8Pv_d8LZsVvz3mQ_9AkzNP0k134MA/exec";
const lebarBaris = 6;

let memoryDB = "";
let variabel = "";
let variabel2 = "";
let currentUser = "";

// ================= FUNGSI BANTU =================
function showStatus(elementId, message, type = 'info') {
  const statusEl = document.getElementById(elementId);
  statusEl.textContent = message;
  statusEl.className = 'status-message';
  
  switch(type) {
    case 'success':
      statusEl.classList.add('status-success');
      break;
    case 'error':
      statusEl.classList.add('status-error');
      break;
    case 'loading':
      statusEl.classList.add('status-loading');
      break;
  }
}

function setLoading(buttonId, isLoading, loadingText = 'Memproses...') {
  const btn = document.getElementById(buttonId);
  if (isLoading) {
    btn.disabled = true;
    btn.innerHTML = `<span class="loading-spinner"></span> ${loadingText}`;
  } else {
    btn.disabled = false;
    if (buttonId === 'loginText') {
      btn.innerHTML = 'üîë Login';
    } else if (buttonId === 'updateText') {
      btn.innerHTML = 'üîÑ Update Nilai';
    } else if (buttonId === 'saveText') {
      btn.innerHTML = 'üíæ Simpan ke Google Sheet';
    }
  }
}

// ================= LOGIN =================
function login() {
  const user = document.getElementById("user").value.trim();
  const pass = document.getElementById("pass").value.trim();

  if (!user || !pass) {
    showStatus('loginStatus', '‚ùå Username dan password harus diisi', 'error');
    return;
  }

  setLoading('loginText', true, 'Memproses login...');
  showStatus('loginStatus', 'üîç Mencari data pengguna...', 'loading');

  // Escape single quotes untuk query
  const safeUser = user.replace(/'/g, "\\'");
  const safePass = pass.replace(/'/g, "\\'");

  const query = `
    SELECT A
    WHERE A LIKE '${safeUser}()${safePass}()%'
  `;

  const url = `https://script.google.com/macros/s/AKfycbwj5Prv7z1QICIr8eaJfi238Eu4tA_LlH_yetxsZEG1u58XQNhlib9wJxfpKobQ0WcMJQ/exec`;

  fetch(url)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      
      if (!json.table.rows.length) {
        showStatus('loginStatus', '‚ùå Login gagal. Username atau password salah.', 'error');
        setLoading('loginText', false);
        return;
      }

      // Simpan data user yang login
      memoryDB = json.table.rows[0].c[0].v;
      currentUser = user;
      
      // Pisahkan variabel
      const parts = memoryDB.split('#');
      variabel2 = parts[0];
      variabel = parts[1] || "";
      
      // Tampilkan aplikasi utama
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      
      // Render data
      renderTable();
      showStatus('loginStatus', '', 'info');
      setLoading('loginText', false);
      
      // Tampilkan notifikasi sukses
      setTimeout(() => {
        showStatus('updateStatus', '‚úÖ Login berhasil! Data siswa dimuat.', 'success');
        setTimeout(() => {
          showStatus('updateStatus', '', 'info');
        }, 3000);
      }, 500);
      
    })
    .catch(error => {
      console.error('Login error:', error);
      showStatus('loginStatus', '‚ùå Koneksi ke Google Sheet gagal. Periksa koneksi internet.', 'error');
      setLoading('loginText', false);
    });
}

// ================= RENDER TABLE =================
function renderTable() {
  if (!variabel) return;

  // Update info siswa
  const meta = variabel2.split("()");
  document.getElementById("namaSiswa").textContent = meta[2] || "-";
  document.getElementById("kelasSiswa").textContent = meta[3] || "-";
  document.getElementById("kodeSiswa").textContent = meta[4] || "-";

  // Render tabel
  const tbody = document.querySelector("#nilaiTable tbody");
  tbody.innerHTML = "";

  const data = variabel.split("|");
  const jumlahBaris = Math.ceil(data.length / lebarBaris);

  for (let baris = 0; baris < jumlahBaris; baris++) {
    const tr = document.createElement("tr");
    const materiIndex = baris * lebarBaris;
    
    // Pastikan BAB ada dalam format yang benar
    let materi = data[materiIndex] || `BAB ${baris + 1}`;
    if (!materi.startsWith('BAB')) {
      materi = `BAB ${baris + 1}`;
    }
    
    tr.innerHTML = `
      <td class="materi-cell">${materi}</td>
      <td>${data[materiIndex + 1] || 0}</td>
      <td>${data[materiIndex + 2] || 0}</td>
      <td>${data[materiIndex + 3] || 0}</td>
      <td>${data[materiIndex + 4] || 0}</td>
      <td>${data[materiIndex + 5] || 0}</td>
    `;
    tbody.appendChild(tr);
  }

  // Update variabel tampilan
  document.getElementById("hasil").textContent = variabel2 + "#" + variabel;
}

// ================= UPDATE DATA =================
function updateData() {
  const posisiBAB = parseInt(document.getElementById("posBab").value);
  const posisiNilai = parseInt(document.getElementById("posNilai").value);
  const nilaiBaru = document.getElementById("nilaiBaru").value;

  // Validasi input
  if (posisiBAB < 1 || posisiBAB > 5) {
    showStatus('updateStatus', '‚ùå Posisi BAB harus antara 1-5', 'error');
    return;
  }

  if (posisiNilai < 1 || posisiNilai > 5) {
    showStatus('updateStatus', '‚ùå Posisi nilai harus antara 1-5', 'error');
    return;
  }

  if (nilaiBaru === "" || isNaN(nilaiBaru)) {
    showStatus('updateStatus', '‚ùå Nilai baru harus berupa angka', 'error');
    return;
  }

  const nilai = parseInt(nilaiBaru);
  if (nilai < 0 || nilai > 100) {
    showStatus('updateStatus', '‚ùå Nilai harus antara 0-100', 'error');
    return;
  }

  setLoading('updateText', true, 'Mengupdate...');
  showStatus('updateStatus', 'üîÑ Memperbarui nilai...', 'loading');

  // Update data di memory
  let data = variabel.split("|");
  const index = ((posisiBAB - 1) * lebarBaris) + posisiNilai;

  if (index < 0 || index >= data.length) {
    // Jika data belum ada, extend array
    while (data.length <= index) {
      data.push("0");
    }
  }

  data[index] = nilai.toString();
  variabel = data.join("|");

  // Render ulang tabel
  setTimeout(() => {
    renderTable();
    setLoading('updateText', false);
    showStatus('updateStatus', `‚úÖ Nilai BAB ${posisiBAB}, posisi ${posisiNilai} berhasil diupdate menjadi ${nilai}`, 'success');
    
    // Reset status setelah 3 detik
    setTimeout(() => {
      showStatus('updateStatus', '', 'info');
    }, 3000);
  }, 500);
}

// ================= SIMPAN KE GOOGLE SHEET =================
async function saveToGoogleSheet() {
  if (!currentUser || !memoryDB) {
    showStatus('saveStatus', '‚ùå Harap login terlebih dahulu', 'error');
    return;
  }

  setLoading('saveText', true, 'Menyimpan...');
  showStatus('saveStatus', 'üì§ Mengirim data ke Google Sheet...', 'loading');

  try {
    // Format data untuk dikirim
    const dataToSend = {
      user: currentUser,
      data: variabel2 + "#" + variabel,
      timestamp: new Date().toISOString(),
      action: "update_scores"
    };

    const response = await fetch(GAS_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(dataToSend),
      mode: 'no-cors'
    });

    // Karena mode: 'no-cors', kita tidak bisa membaca response
    // Tapi request akan tetap dikirim
    setTimeout(() => {
      setLoading('saveText', false);
      showStatus('saveStatus', '‚úÖ Data berhasil dikirim ke Google Sheet!', 'success');
      
      // Reset status setelah 5 detik
      setTimeout(() => {
        showStatus('saveStatus', '', 'info');
      }, 5000);
    }, 1500);

  } catch (error) {
    console.error('Save error:', error);
    setLoading('saveText', false);
    showStatus('saveStatus', `‚ùå Gagal menyimpan: ${error.message}`, 'error');
  }
}


// ================= INISIALISASI =================
window.onload = function() {
  // Set nilai default untuk testing
  document.getElementById("user").value = "chair";
  document.getElementById("pass").value = "Login";
  
  // Focus ke input user
  document.getElementById("user").focus();
  
  // Enter key support
  document.getElementById("pass").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      login();
    }
  });
  
  console.log("Aplikasi Tebaran Nilai siap digunakan");
};
</script>

</body>
</html>
